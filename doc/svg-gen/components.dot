digraph components {
  node [shape = "box"];
  compound = true;
  // newrank = true;
  rankdir = "TB";

  MidiInputDevice;
  MidiOutputDevice;
  FxChain;
  Reaper;

  subgraph cluster_realearn {
    App [class = "infrastructure"];
    Server [class = "infrastructure"];
    Backbone [class = "processing"];
    RealearnControlSurfaceMiddleware [class = "processing"];
    RealearnAudioHook [class = "processing"];
    OscOutputDevice [class = "processing"];

    subgraph cluster_instance {
      infrastructure_layer [shape = point style = invis];
      application_layer [shape = point style = invis];
      processing_layer [shape = point style = invis];
      RealearnPlugin [class = "infrastructure"];
      RealearnUi [class = "infrastructure"];
      Session [class = "management"];
      InstanceState [class = "processing"];
      RealTimeProcessor [width = 2, height = 3, class = "processing"];
      MainProcessor [width = 2, height = 3, class = "processing"];

      {
        rank = same;
        infrastructure_layer;
        RealearnUi;
      }
      {
        rank = same;
        application_layer;
        Session;
      }
      {
        rank = same;
        processing_layer;
        RealTimeProcessor;
        MainProcessor;
        InstanceState;
      }

      label = "Instance";
      class = "level-2";
      infrastructure_layer -> application_layer -> processing_layer [style = invis];
    }

    label = "ReaLearn";
    class = "level-1";
  }


  // General
  Session -> MainProcessor [label = "Sync mappings", class = "async"]
  MainProcessor -> RealTimeProcessor [label = "Sync mappings", class = "async"]
  MainProcessor -> Session [label = "Events"]
  Session -> RealearnUi [label = "Events"]

  // Feedback direction
  Reaper -> RealearnControlSurfaceMiddleware [label = "REAPER change events"]
  InstanceState -> RealearnControlSurfaceMiddleware [label = "Instance change events", class = "async"]
  RealearnControlSurfaceMiddleware -> MainProcessor [label = "REAPER and instance change events"]

  // Control direction (OSC)
  RealearnControlSurfaceMiddleware -> MainProcessor [label = "OSC control events"]

  // Feedback direction (OSC)
  MainProcessor -> OscOutputDevice [label = "OSC feedback events", class = "async"]

  // Control direction (MIDI)
  RealTimeProcessor -> MainProcessor [label = "Control values (from MIDI events)", class = "async"]

  // Control direction (MIDI, FX input)
  FxChain -> RealearnPlugin [label = "MIDI control events (FX input)"]
  RealearnPlugin -> RealTimeProcessor [label = "MIDI control events (FX input)"]

  // Feedback direction (MIDI, FX output)
  MainProcessor -> RealTimeProcessor [label = "MIDI feedback events (FX output)", class = "async"]
  RealTimeProcessor -> FxChain [label = "MIDI feedback events (FX output)", constraint = false]

  // Control direction (MIDI, device input)
  MidiInputDevice -> RealearnAudioHook [label = "MIDI control events (device input)"]
  RealearnAudioHook -> RealTimeProcessor [label = "MIDI control events (device input)"]

  // Feedback direction (MIDI, device output)
  MainProcessor -> RealearnAudioHook [label = "MIDI feedback events (device output)", class = "async"]
  RealearnAudioHook -> MidiOutputDevice [label = "MIDI feedback events (device output)"]
}